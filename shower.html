<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Електронна черга в душ</title>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,500,700&display=swap" rel="stylesheet">
  <style>
    /* Загальний сучасний дизайн */
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 0;
      background: #eef2f3;
    }
    .container {
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
    }
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    .header h1 {
      font-size: 2.5em;
      margin: 0;
      color: #333;
    }
    /* Форма бронювання */
    .booking-form {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      max-width: 500px;
      margin: 0 auto 30px auto;
    }
    .booking-form input,
    .booking-form select,
    .booking-form button {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    /* Група для вирівнювання дати, часу та додаткового часу */
    .date-time-group {
      display: flex;
      gap: 10px;
    }
    .date-time-group input,
    .date-time-group select {
      flex: 1;
      margin: 0;
    }
    .booking-form button {
      background: #007bff;
      color: #fff;
      border: none;
      cursor: pointer;
      transition: background 0.3s;
    }
    .booking-form button:hover {
      background: #0056b3;
    }
    /* Кнопка скасування */
    #cancelBtnContainer {
      text-align: center;
      margin-top: 10px;
      display: none;
    }
    #cancelBtn {
      padding: 10px;
      background: #d32f2f;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s;
    }
    #cancelBtn:hover {
      background: #b71c1c;
    }
    /* VIP банер */
    #vipBanner {
      background: linear-gradient(90deg, #ff9a9e, #fad0c4);
      color: #fff;
      padding: 10px;
      border-radius: 8px;
      text-align: center;
      margin-bottom: 15px;
      display: none;
      font-weight: bold;
      font-size: 16px;
    }
    /* Черга та бронювання */
    .queue-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }
    .queue-box {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      flex: 1;
      min-width: 300px;
    }
    .queue-box h3 {
      margin-top: 0;
      color: #333;
    }
    .queue-box ul {
      list-style: none;
      padding: 0;
    }
    .queue-box li {
      padding: 8px;
      border-bottom: 1px solid #eee;
    }
    /* Прогрес-бар */
    .progress-bar {
      background: #ddd;
      border-radius: 4px;
      overflow: hidden;
      height: 20px;
      margin-top: 10px;
    }
    .progress {
      background: #4caf50;
      height: 100%;
      width: 0%;
      transition: width 1s linear;
    }
    .confirm-btn {
      background: #ff9800;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 10px;
      cursor: pointer;
      transition: background 0.3s;
      margin-top: 10px;
    }
    .confirm-btn:hover {
      background: #e68900;
    }
    /* Лідери */
    #leaderboardContainer {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin-top: 30px;
    }
    #leaderboardContainer h3 {
      margin-top: 0;
      font-size: 1.8em;
      color: #333;
    }
    #leaderboardTable {
      width: 100%;
      border-collapse: collapse;
    }
    #leaderboardTable th, #leaderboardTable td {
      padding: 10px;
      border: 1px solid #eee;
      text-align: center;
    }
    #leaderboardTable th {
      background: #f0f0f0;
    }
    .leader-first { font-size: 18px; color: #FFD700; font-weight: bold; }
    .leader-second { font-size: 16px; color: #C0C0C0; font-weight: bold; }
    .leader-third { font-size: 14px; color: #CD7F32; font-weight: bold; }
    /* Чат */
    .chat-container {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      padding: 20px;
      margin-top: 30px;
    }
    .chat-container h3 {
      margin-top: 0;
      color: #333;
    }
    #chatPanel {
      height: 200px;
      overflow-y: auto;
      border: 1px solid #eee;
      padding: 10px;
      background: #fafafa;
      border-radius: 6px;
    }
    #chatInput {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    #sendChatBtn {
      margin-top: 10px;
      padding: 10px;
      width: 100%;
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s;
    }
    #sendChatBtn:hover {
      background: #0056b3;
    }
    #chatWarning {
      margin-top: 10px;
      color: #d32f2f;
      font-size: 0.9em;
    }
    /* Міні-гра: Tanks (Pac-Man замінено на танчики) */
    .minigame {
      margin-top: 30px;
      background: #e9f5ff;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      position: relative;
    }
    .minigame h3 {
      margin-top: 0;
      color: #333;
    }
    #gameCanvas {
      background: #000;
      display: block;
      margin: 0 auto 15px auto;
      border-radius: 8px;
    }
    #gameScore {
      font-size: 1.2em;
      font-weight: bold;
      color: #333;
    }
    #startMiniGameBtn {
      padding: 10px 20px;
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s;
    }
    #startMiniGameBtn:hover {
      background: #0056b3;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Форма бронювання -->
    <div class="booking-form">
      <div id="vipBanner"></div>
      <h1>Електронна черга в душ</h1>
      <input type="text" id="userName" placeholder="Введіть своє ім'я">
      <div class="date-time-group">
        <input type="date" id="reservationDate">
        <input type="time" id="reservationTime">
        <select id="extraTime">
          <option value="0">Базові 15 хв</option>
          <option value="5">+5 хв (20 хвилин)</option>
          <option value="10">+10 хв (25 хвилин)</option>
        </select>
      </div>
      <button id="bookBtn">Забронювати</button>
      <div id="cancelBtnContainer">
        <button id="cancelBtn">Скасувати візит</button>
      </div>
    </div>

    <!-- Черга та поточне бронювання -->
    <div class="queue-container">
      <div class="queue-box" id="currentReservationBox">
        <h3>Зараз миється:</h3>
        <div id="currentReservation">Душ вільний!</div>
        <div class="progress-bar">
          <div class="progress" id="progressBar"></div>
        </div>
        <div id="confirmContainer"></div>
      </div>
      <div class="queue-box" id="reservationQueueBox">
        <h3>Черга бронювань</h3>
        <ul id="reservationQueue"></ul>
      </div>
    </div>

    <!-- Лідери -->
    <div id="leaderboardContainer">
      <h3>Лідери бронювань</h3>
      <table id="leaderboardTable">
        <thead>
          <tr>
            <th>Місце</th>
            <th>Ім'я</th>
            <th>Бали</th>
          </tr>
        </thead>
        <tbody id="leaderboardBody"></tbody>
      </table>
    </div>

    <!-- Міні чат -->
    <div class="chat-container">
      <h3>Міні чат</h3>
      <div id="chatPanel"></div>
      <input type="text" id="chatInput" placeholder="Тільки учасники бронювання можуть писати" disabled>
      <button id="sendChatBtn">Надіслати</button>
      <div id="chatWarning" style="display:none;">Ви не забронювали!</div>
    </div>

    <!-- Міні-гра: Tanks (гра на canvas) -->
    <div class="minigame" id="minigameArea" style="display:none;">
      <h3>Міні-гра: Танчики</h3>
      <canvas id="gameCanvas" width="300" height="300"></canvas>
      <p>Ваш рахунок: <span id="gameScore">0</span></p>
      <button id="startMiniGameBtn">Почати гру</button>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    /***** Firebase Configuration *****/
    // Замініть ці дані на свої з Firebase Console
    var firebaseConfig = {
        apiKey: "AIzaSyBgpL3-TVnAzVvGP4AGcPmzYOjTvU9G3P4",
      authDomain: "toiletqueue-be126.firebaseapp.com",
      databaseURL: "https://toiletqueue-be126-default-rtdb.europe-west1.firebasedatabase.app/",
      projectId: "toiletqueue-be126",
      storageBucket: "toiletqueue-be126.firebasestorage.app",
      messagingSenderId: "391582777538",
      appId: "1:391582777538:web:da61462bf4a65954f6fb5b"
    };
    firebase.initializeApp(firebaseConfig);
    var db = firebase.database();

    /***** Глобальні змінні для бронювання *****/
    var reservationsRef = db.ref("showerReservations");
    var leaderboardRef = db.ref("showerLeaderboard");
    var chatRef = db.ref("showerChat");
    var currentReservations = [];
    var progressInterval = null;
    var currentReservation = null;
    var miniGameDuration = 33; // секунд для Tanks гри
    var miniGameTimer, miniGameInterval;
    var miniGameTimeLeft, miniGameScore = 0;
    var miniGameActive = false;

    /***** Автоматичне встановлення дати та часу *****/
    window.addEventListener("load", function(){
      var today = new Date();
      var yyyy = today.getFullYear();
      var mm = ("0" + (today.getMonth()+1)).slice(-2);
      var dd = ("0" + today.getDate()).slice(-2);
      document.getElementById("reservationDate").value = yyyy + "-" + mm + "-" + dd;
      var hh = ("0" + today.getHours()).slice(-2);
      var min = ("0" + today.getMinutes()).slice(-2);
      document.getElementById("reservationTime").value = hh + ":" + min;
    });

    /***** Функції бронювання *****/
    document.getElementById("bookBtn").addEventListener("click", function() {
      var name = document.getElementById("userName").value.trim();
      var date = document.getElementById("reservationDate").value;
      var time = document.getElementById("reservationTime").value;
      var extra = parseInt(document.getElementById("extraTime").value);
      if (!name || !date || !time) {
        alert("Будь ласка, введіть ім'я та підтвердіть дату й час бронювання!");
        return;
      }
      reservationsRef.child(date).once("value", function(snapshot) {
        var data = snapshot.val() || {};
        if (data[name]) {
          alert("Такий користувач вже забронював для цієї дати!");
          return;
        }
        var reservedTime = 15 + extra; // хвилин
        var scheduledStart = new Date(date + "T" + time + ":00").getTime();
        var reservation = {
          name: name,
          reservedTime: reservedTime,
          scheduledStart: scheduledStart,
          confirmed: false
        };
        var updates = {};
        updates[name] = reservation;
        reservationsRef.child(date).update(updates);
        localStorage.setItem("userName", name);
      });
    });

    /***** Слухач бронювань *****/
    var todayStr = new Date().toISOString().split("T")[0];
    reservationsRef.child(todayStr).on("value", function(snapshot) {
      var data = snapshot.val() || {};
      currentReservations = [];
      for (var key in data) {
        currentReservations.push(data[key]);
      }
      currentReservations.sort(function(a, b) {
        return a.scheduledStart - b.scheduledStart;
      });
      updateQueueDisplay();
      updateCurrentReservation();
      updateLeaderboard();
      updateChatPermission();
      updateVIPBanner();
      updateCancelButton();
    });

    function updateQueueDisplay() {
      var queueList = document.getElementById("reservationQueue");
      queueList.innerHTML = "";
      if (currentReservations.length === 0) {
        var li = document.createElement("li");
        li.textContent = "Черга порожня!";
        li.style.textAlign = "center";
        queueList.appendChild(li);
      } else {
        currentReservations.forEach(function(res, index) {
          var li = document.createElement("li");
          // Форматуємо час (HH:MM)
          var d = new Date(res.scheduledStart);
          var hh = d.getHours();
          var mm = d.getMinutes();
          hh = (hh < 10) ? "0" + hh : hh;
          mm = (mm < 10) ? "0" + mm : mm;
          li.textContent = (index + 1) + ". " + res.name + " (" + res.reservedTime + " хв, " + hh + ":" + mm + ")";
          queueList.appendChild(li);
        });
      }
    }

    function updateCurrentReservation() {
      var now = Date.now();
      currentReservation = null;
      currentReservations.forEach(function(res) {
        var endTime = res.scheduledStart + res.reservedTime * 60 * 1000;
        if (now >= res.scheduledStart && now < endTime) {
          currentReservation = res;
        }
      });
      var currentDiv = document.getElementById("currentReservation");
      if (currentReservation) {
        var elapsed = now - currentReservation.scheduledStart;
        var total = currentReservation.reservedTime * 60 * 1000;
        var remainingTime = total - elapsed;
        var minutesRemaining = Math.floor(remainingTime / 60000);
        var secondsRemaining = Math.floor((remainingTime % 60000) / 1000);
        currentDiv.textContent = "Зараз миється: " + currentReservation.name + " (" + minutesRemaining + " хв " + (secondsRemaining < 10 ? "0" : "") + secondsRemaining + " сек залишилося)";
        var percent = Math.min(100, (elapsed / total) * 100);
        document.getElementById("progressBar").style.width = percent + "%";
        if (!currentReservation.confirmed && (total - elapsed <= 5 * 60 * 1000)) {
          document.getElementById("confirmContainer").innerHTML = '<button class="confirm-btn" onclick="confirmReservation()">Підтвердити візит</button>';
        } else {
          document.getElementById("confirmContainer").innerHTML = "";
        }
      } else {
        currentDiv.textContent = "Душ вільний!";
        document.getElementById("progressBar").style.width = "0%";
        document.getElementById("confirmContainer").innerHTML = "";
      }
    }

    // Щосекундне оновлення інформації про бронювання (для реального часу)
    setInterval(updateCurrentReservation, 1000);

    function confirmReservation() {
      if (!currentReservation) return;
      reservationsRef.child(todayStr).child(currentReservation.name).update({ confirmed: true });
      alert("Візит підтверджено!");
    }

    /***** Лідери *****/
    function updateLeaderboard() {
      var leaderboardData = {};
      currentReservations.forEach(function(res) {
        leaderboardData[res.name] = (leaderboardData[res.name] || 0) + 1;
      });
      leaderboardRef.child(todayStr).set(leaderboardData);
      updateLeaderboardDisplay();
    }
    function updateLeaderboardDisplay() {
      leaderboardRef.child(todayStr).once("value", function(snapshot) {
        var data = snapshot.val() || {};
        var entries = [];
        for (var key in data) {
          entries.push({ name: key, score: data[key] });
        }
        entries.sort(function(a, b) { return b.score - a.score; });
        var tbody = document.getElementById("leaderboardBody");
        tbody.innerHTML = "";
        entries.slice(0, 5).forEach(function(entry, index) {
          var tr = document.createElement("tr");
          if (index === 0) tr.classList.add("leader-first");
          else if (index === 1) tr.classList.add("leader-second");
          else if (index === 2) tr.classList.add("leader-third");
          var tdRank = document.createElement("td");
          tdRank.innerText = index + 1;
          var tdName = document.createElement("td");
          tdName.innerText = entry.name;
          var tdScore = document.createElement("td");
          tdScore.innerText = entry.score;
          tr.appendChild(tdRank);
          tr.appendChild(tdName);
          tr.appendChild(tdScore);
          tbody.appendChild(tr);
        });
      });
    }

    /***** VIP *****/
    function updateVIPBanner() {
      var vipBanner = document.getElementById("vipBanner");
      var name = localStorage.getItem("userName");
      if (name && name.toLowerCase() === "начальник") {
        vipBanner.style.display = "block";
        vipBanner.innerText = "Вітаємо, VIP! Ви маєте пріоритетний доступ та особливі привілеї!";
      } else {
        vipBanner.style.display = "none";
      }
    }

    /***** Чат *****/
    document.getElementById("chatInput").addEventListener("keydown", function(e) {
      if (e.key === "Enter") {
        e.preventDefault();
        sendChat();
      }
    });
    document.getElementById("sendChatBtn").addEventListener("click", sendChat);
    chatRef.on("child_added", function(snapshot) {
      var message = snapshot.val();
      displayChatMessage(message);
    });
    function displayChatMessage(message) {
      var chatPanel = document.getElementById("chatPanel");
      var div = document.createElement("div");
      div.className = "chat-message";
      div.innerHTML = "<span>" + message.name + ":</span> " + message.text;
      chatPanel.appendChild(div);
      chatPanel.scrollTop = chatPanel.scrollHeight;
    }
    function sendChat() {
      var chatInput = document.getElementById("chatInput");
      var text = chatInput.value.trim();
      var currentUser = localStorage.getItem("userName");
      if (!currentUser || !isUserInQueue(currentUser)) {
        alert("Для написання повідомлень потрібно бути в бронюванні!");
        return;
      }
      if (!text) return;
      var message = {
        name: currentUser,
        text: text,
        timestamp: Date.now()
      };
      chatRef.push(message);
      chatInput.value = "";
    }
    function isUserInQueue(userName) {
      return currentReservations.some(function(res) {
        return res.name === userName;
      });
    }
    function updateChatPermission() {
      var currentUser = localStorage.getItem("userName");
      var chatInput = document.getElementById("chatInput");
      var chatWarning = document.getElementById("chatWarning");
      if (currentUser && isUserInQueue(currentUser)) {
        chatInput.disabled = false;
        chatInput.placeholder = "Ваше повідомлення";
        chatWarning.style.display = "none";
      } else {
        chatInput.disabled = true;
        chatInput.placeholder = "Тільки учасники бронювання можуть писати";
        chatWarning.style.display = "block";
        chatWarning.innerText = "Ви не забронювали!";
      }
    }

    /***** Кнопка скасування бронювання *****/
    document.getElementById("cancelBtn").addEventListener("click", cancelReservation);
    function updateCancelButton() {
      var currentUser = localStorage.getItem("userName");
      var found = currentReservations.some(function(res) {
        return res.name === currentUser;
      });
      var cancelContainer = document.getElementById("cancelBtnContainer");
      cancelContainer.style.display = found ? "block" : "none";
    }
    function cancelReservation() {
      var currentUser = localStorage.getItem("userName");
      if (!currentUser) return;
      reservationsRef.child(todayStr).child(currentUser).remove(function(error) {
        if (error) {
          alert("Помилка скасування бронювання");
        } else {
          alert("Ваш візит скасовано");
        }
      });
    }

    /***** Міні-гра: Tanks (замість Pac-Man) *****/
    // Реалізація дуже спрощеної гри "Танчики" на canvas.
    // Гравець керує танком (трикутник), може обертатись і рухатись вперед.
    // Клавіші: стрілки для керування, пробіл для стрільби.
    // Для спрощення, у цій версії вороги не з'являються, лише обчислюється рахунок за рух.
    var canvas = document.getElementById("gameCanvas");
    var ctx = canvas.getContext("2d");
    var tank = { x: canvas.width / 2, y: canvas.height - 40, angle: -Math.PI/2, speed: 0 };
    var bullets = [];
    var tankScore = 0;
    var tankGameInterval;
    function initTankGame() {
      tank = { x: canvas.width / 2, y: canvas.height - 40, angle: -Math.PI/2, speed: 0 };
      bullets = [];
      tankScore = 0;
      clearInterval(tankGameInterval);
      tankGameInterval = setInterval(tankGameLoop, 50);
      document.getElementById("startMiniGameBtn").style.display = "none";
    }
    function tankGameLoop() {
      // Оновлення позиції танку
      tank.x += tank.speed * Math.cos(tank.angle);
      tank.y += tank.speed * Math.sin(tank.angle);
      // Обмеження за межами canvas
      if(tank.x < 0) tank.x = 0;
      if(tank.x > canvas.width) tank.x = canvas.width;
      if(tank.y < 0) tank.y = 0;
      if(tank.y > canvas.height) tank.y = canvas.height;
      // Оновлення куль
      for(var i = 0; i < bullets.length; i++){
        bullets[i].x += bullets[i].speed * Math.cos(bullets[i].angle);
        bullets[i].y += bullets[i].speed * Math.sin(bullets[i].angle);
        // Видалення куль за межами canvas
        if(bullets[i].x < 0 || bullets[i].x > canvas.width || bullets[i].y < 0 || bullets[i].y > canvas.height){
          bullets.splice(i,1);
          i--;
          continue;
        }
      }
      tankScore++;
      document.getElementById("gameScore").innerText = tankScore;
      drawTankGame();
    }
    function drawTankGame() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      // Малюємо танк (трикутник)
      ctx.fillStyle = "#FFEB3B";
      ctx.save();
      ctx.translate(tank.x, tank.y);
      ctx.rotate(tank.angle);
      ctx.beginPath();
      ctx.moveTo(0, -15);
      ctx.lineTo(10, 15);
      ctx.lineTo(-10, 15);
      ctx.closePath();
      ctx.fill();
      ctx.restore();
      // Малюємо кулі
      ctx.fillStyle = "#FF5722";
      bullets.forEach(function(bullet) {
        ctx.beginPath();
        ctx.arc(bullet.x, bullet.y, 4, 0, 2 * Math.PI);
        ctx.fill();
      });
    }
    document.addEventListener("keydown", function(e) {
      if(e.keyCode === 37) { // ліворуч - обертання
        tank.angle -= 0.1;
      } else if(e.keyCode === 39) { // праворуч - обертання
        tank.angle += 0.1;
      } else if(e.keyCode === 38) { // вперед
        tank.speed = 4;
      } else if(e.keyCode === 40) { // назад
        tank.speed = -2;
      } else if(e.keyCode === 32) { // пробіл - стрільба
        bullets.push({ x: tank.x, y: tank.y, angle: tank.angle, speed: 6 });
      }
    });
    document.addEventListener("keyup", function(e) {
      if(e.keyCode === 38 || e.keyCode === 40) {
        tank.speed = 0;
      }
    });
    function endTankGame() {
      clearInterval(tankGameInterval);
      alert("Гру завершено! Ваш рахунок: " + tankScore);
      document.getElementById("startMiniGameBtn").style.display = "inline-block";
    }
    document.getElementById("startMiniGameBtn").addEventListener("click", initTankGame);

  </script>
</body>
</html>
