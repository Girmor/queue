<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Електронна черга в туалет</title>
  <style>
    /* Загальні стилі */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background: url('https://www.transparenttextures.com/patterns/diagmonds-light.png');
      background-color: #f8f9fa;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }
    .container {
      background: #fff;
      max-width: 600px;
      width: 90%;
      padding: 30px 20px;
      margin: 20px;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
      text-align: center;
      position: relative;
      overflow: hidden;
      animation: slideDown 0.8s ease-out;
    }
    @keyframes slideDown {
      from { transform: translateY(-50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .header-img {
      width: 80px;
      height: auto;
      margin-bottom: 10px;
      animation: bounce 2s infinite;
    }
    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-15px); }
      60% { transform: translateY(-8px); }
    }
    h1 {
      margin: 0;
      color: #343a40;
    }
    p {
      color: #6c757d;
      margin-bottom: 20px;
    }
    .vip-note {
      font-size: 14px;
      color: #d9534f;
      margin-bottom: 10px;
    }
    .input-group {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
    }
    input[type="text"] {
      width: 60%;
      padding: 10px;
      border: 2px solid #ced4da;
      border-radius: 4px;
      font-size: 16px;
      transition: border-color 0.3s;
    }
    input[type="text"]:focus {
      outline: none;
      border-color: #80bdff;
    }
    button {
      padding: 10px 20px;
      margin-left: 10px;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.3s, transform 0.2s;
    }
    button:hover {
      transform: scale(1.05);
    }
    .primary-btn {
      background: #007bff;
      color: #fff;
    }
    .primary-btn:hover {
      background: #0056b3;
    }
    .btn-secondary {
      background: #6c757d;
      color: #fff;
    }
    .btn-secondary:hover {
      background: #5a6268;
    }
    #queueList {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #queueList li {
      padding: 12px 15px;
      border-bottom: 1px solid #dee2e6;
      text-align: left;
      opacity: 0;
      animation: fadeIn 0.5s forwards;
    }
    #queueList li.current {
      background: #d4edda;
      font-weight: bold;
      position: relative;
    }
    @keyframes fadeIn {
      to { opacity: 1; }
    }
    button:active {
      transform: scale(0.95);
    }
    /* Структура сірника */
    .match-container {
      margin-top: 10px;
      text-align: center;
    }
    .match {
      position: relative;
      width: 40px;
      height: 100px;
      margin: 0 auto;
    }
    /* Голівка сірника з пульсацією */
    .match-head {
      position: absolute;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      width: 24px;
      height: 24px;
      background: radial-gradient(circle, #ff9800, #f44336);
      border-radius: 50%;
      z-index: 2;
    }
    .match-head.pulse {
      animation: flamePulse 1s infinite;
    }
    @keyframes flamePulse {
      0%, 100% { transform: translateX(-50%) scale(1); }
      50% { transform: translateX(-50%) scale(1.1); }
    }
    /* Тіло сірника */
    .match-stick {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 8px;
      height: 80px;
      background: #8b4513;
      border-radius: 4px;
      overflow: hidden;
    }
    /* Згораюча частина з мерехтінням */
    .burn-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      background: #f44336;
      opacity: 0.7;
      height: 100%;
      transition: height 1s linear;
    }
    .burn-overlay.flicker {
      animation: flicker 0.2s infinite;
    }
    @keyframes flicker {
      0% { opacity: 0.7; filter: brightness(1); }
      50% { opacity: 0.9; filter: brightness(1.2); }
      100% { opacity: 0.7; filter: brightness(1); }
    }
    .remaining-text {
      margin-top: 5px;
      font-size: 14px;
      color: #333;
    }
  </style>
</head>
<body>
  <div class="container">
    <img src="https://img.icons8.com/ios-filled/100/toilet.png" alt="Toilet Icon" class="header-img" />
    <h1>Електронна черга в туалет</h1>
    <p>Введіть своє ім'я, щоб увійти до черги</p>
    <!-- Примітка для VIP гостей -->
    <div class="vip-note">VIP гості ("Начальник") обслуговуються без черги!</div>
    <div class="input-group">
      <input type="text" id="nameInput" placeholder="Ваше ім'я">
      <button class="primary-btn" onclick="joinQueue()">Встати в чергу</button>
    </div>
    
    <ul id="queueList"></ul>
    
    <div style="margin-top: 20px;">
      <!-- Кнопка звільнення туалету; активна тільки для поточного користувача -->
      <button class="btn-secondary" id="advanceButton" onclick="advanceQueue()">Туалет звільнився!</button>
    </div>
  </div>

  <!-- Підключення Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    // Запит дозволу на показ нотифікацій
    if ("Notification" in window) {
      if (Notification.permission !== "granted" && Notification.permission !== "denied") {
        Notification.requestPermission();
      }
    }

    // TODO: Замініть наступні значення на свої дані Firebase
    var firebaseConfig = {
      apiKey: "AIzaSyBgpL3-TVnAzVvGP4AGcPmzYOjTvU9G3P4",
      authDomain: "toiletqueue-be126.firebaseapp.com",
      databaseURL: "https://toiletqueue-be126-default-rtdb.europe-west1.firebasedatabase.app/",
      projectId: "toiletqueue-be126",
      storageBucket: "toiletqueue-be126.firebasestorage.app",
      messagingSenderId: "391582777538",
      appId: "1:391582777538:web:da61462bf4a65954f6fb5b"
    };

    firebase.initializeApp(firebaseConfig);
    var db = firebase.database();
    var queueRef = db.ref("queue");

    // Час перебування встановлено на 10 хвилин (600000 мс)
    const allowedTime = 10 * 60 * 1000;

    let lastOccupant = null;
    let progressInterval = null;
    let currentQueue = [];

    // Функція для обчислення залишкового часу у форматі "X хв YY сек"
    function getRemainingTime(personObj) {
      if (!personObj.startedAt) return "";
      var remaining = allowedTime - (Date.now() - personObj.startedAt);
      if (remaining < 0) remaining = 0;
      var minutes = Math.floor(remaining / 60000);
      var seconds = Math.floor((remaining % 60000) / 1000);
      return minutes + " хв " + (seconds < 10 ? "0" : "") + seconds + " сек";
    }

    // Оновлення сірника: змінюємо висоту overlay та оновлюємо текст
    function updateMatch() {
      if (currentQueue.length === 0 || !currentQueue[0].startedAt) return;
      var elapsed = Date.now() - currentQueue[0].startedAt;
      var remaining = allowedTime - elapsed;
      var percentage = Math.max(0, (remaining / allowedTime) * 100);
      var burnOverlay = document.querySelector(".current .burn-overlay");
      if (burnOverlay) {
        burnOverlay.style.height = percentage + "%";
      }
      var remainingTextElem = document.querySelector(".current .remaining-text");
      if (remainingTextElem) {
        remainingTextElem.innerText = "У " + currentQueue[0].name + " залишилося: " + getRemainingTime(currentQueue[0]);
      }
      if (remaining <= 0) {
        clearInterval(progressInterval);
        progressInterval = null;
      }
    }

    // Оновлення стану кнопки "Туалет звільнився!"
    function updateAdvanceButton() {
      var btn = document.getElementById("advanceButton");
      var currentUser = localStorage.getItem('userName');
      if (currentQueue.length > 0 && currentQueue[0].name === currentUser) {
        btn.disabled = false;
        btn.style.opacity = 1;
        btn.title = "Ви можете звільнити туалет";
      } else {
        btn.disabled = true;
        btn.style.opacity = 0.5;
        btn.title = "Тільки користувач, який знаходиться у туалеті, може звільнити його";
      }
    }

    // Слухач змін в Firebase
    queueRef.on("value", function(snapshot) {
      var queue = snapshot.val() || [];
      currentQueue = queue;

      if (queue.length > 0) {
        if (!queue[0].startedAt) {
          queue[0].startedAt = Date.now();
          queueRef.set(queue);
          return;
        } else {
          var elapsed = Date.now() - queue[0].startedAt;
          if (elapsed >= allowedTime) {
            queue.shift();
            if (Notification.permission === "granted") {
              new Notification("Туалет звільнився!", {
                body: "Ну це капець... так довго не можна сидіти, виходимо!"
              });
            } else {
              alert("Ну це капець... так довго не можна сидіти, виходимо!");
            }
            queueRef.set(queue);
            return;
          }
        }
        if (!progressInterval) {
          progressInterval = setInterval(updateMatch, 1000);
        }
      } else {
        if (progressInterval) {
          clearInterval(progressInterval);
          progressInterval = null;
        }
      }

      // Якщо попередній occupant був, а тепер його нема – оповіщення
      var occupant = (queue.length > 0) ? queue[0].name : null;
      if (lastOccupant && occupant === null) {
        if (Notification.permission === "granted") {
          new Notification("Туалет звільнився!", {
            body: "Ну це капець... так довго не можна сидіти, виходимо!"
          });
        } else {
          alert("Туалет звільнився!");
        }
      }
      lastOccupant = occupant;
      renderQueue(queue);
    });

    // Відображення черги; для першого користувача додається сірник з комбінованою анімацією
    function renderQueue(queue) {
      const queueList = document.getElementById("queueList");
      queueList.innerHTML = "";
      if (queue.length === 0) {
        const li = document.createElement("li");
        li.textContent = "Черга порожня. Туалет вільний!";
        li.style.textAlign = "center";
        li.style.opacity = "1";
        queueList.appendChild(li);
      } else {
        queue.forEach((personObj, index) => {
          const li = document.createElement("li");
          li.style.animationDelay = (index * 0.1) + "s";
          if (index === 0) {
            li.classList.add("current");
            li.innerHTML = "Зараз у туалеті: " + personObj.name;
            // Створення контейнера сірника
            var matchContainer = document.createElement("div");
            matchContainer.className = "match-container";
            var match = document.createElement("div");
            match.className = "match";
            var matchHead = document.createElement("div");
            matchHead.className = "match-head pulse"; // пульсуюча голівка
            var matchStick = document.createElement("div");
            matchStick.className = "match-stick";
            var burnOverlay = document.createElement("div");
            burnOverlay.className = "burn-overlay flicker"; // мерехтить
            burnOverlay.style.height = "100%";
            matchStick.appendChild(burnOverlay);
            match.appendChild(matchHead);
            match.appendChild(matchStick);
            matchContainer.appendChild(match);
            var remainingText = document.createElement("div");
            remainingText.className = "remaining-text";
            remainingText.innerText = "У " + personObj.name + " залишилося: " + getRemainingTime(personObj);
            matchContainer.appendChild(remainingText);
            li.appendChild(matchContainer);
          } else {
            li.textContent = (index + 1) + ". " + personObj.name;
          }
          queueList.appendChild(li);
        });
      }
      updateAdvanceButton();
    }

    // Додавання користувача до черги; зберігаємо ім'я в localStorage. VIP ("Начальник") потрапляє на початок.
    function joinQueue() {
      const nameInput = document.getElementById("nameInput");
      const name = nameInput.value.trim();
      if (!name) {
        alert("Будь ласка, введіть ваше ім'я!");
        return;
      }
      localStorage.setItem('userName', name);
      queueRef.once("value").then(function(snapshot) {
        const currentQueue = snapshot.val() || [];
        if (name.toLowerCase() === "начальник") {
          currentQueue.unshift({ name: name, startedAt: null });
        } else {
          currentQueue.push({ name: name, startedAt: null });
        }
        queueRef.set(currentQueue);
      });
      nameInput.value = "";
    }

    // Ручне звільнення – може натискати тільки користувач, який знаходиться у туалеті.
    function advanceQueue() {
      queueRef.once("value").then(function(snapshot) {
        const currentQueue = snapshot.val() || [];
        if (currentQueue.length === 0) {
          alert("Немає людей у черзі!");
          return;
        }
        currentQueue.shift();
        queueRef.set(currentQueue);
      });
    }

    // При завантаженні сторінки оновлюємо стан кнопки
    document.addEventListener("DOMContentLoaded", updateAdvanceButton);
  </script>
</body>
</html>
